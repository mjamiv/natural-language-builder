<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ”´ Red Team Your Bridge â€” NLB</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0d0f12;
      --surface:   #151820;
      --surface2:  #1c2030;
      --surface3:  #232840;
      --border:    #2a3050;
      --border2:   #3a4570;
      --text:      #e2e8f0;
      --text-dim:  #8892aa;
      --accent:    #4f8ef7;
      --accent-glow: rgba(79,142,247,0.18);
      --green:     #22c55e;
      --yellow:    #eab308;
      --red:       #ef4444;
      --orange:    #f97316;
      --purple:    #a855f7;
      --cyan:      #06b6d4;
      --font-mono: 'JetBrains Mono', 'Fira Mono', 'Cascadia Code', 'Consolas', monospace;
      --font-ui:   'Inter', 'Segoe UI', system-ui, sans-serif;
      --radius:    8px;
      --radius-lg: 12px;
      --shadow:    0 4px 24px rgba(0,0,0,0.5);
    }

    html { height: 100%; }
    body {
      min-height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-ui);
      font-size: 14px;
      line-height: 1.6;
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€ Scrollbars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--surface); }
    ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 32px;
      display: flex;
      align-items: center;
      gap: 16px;
      height: 64px;
      flex-shrink: 0;
    }
    .header-logo {
      font-size: 26px;
      line-height: 1;
      filter: drop-shadow(0 0 8px rgba(239,68,68,0.6));
    }
    .header-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.4px;
      color: var(--text);
    }
    .header-sub {
      font-size: 12px;
      color: var(--text-dim);
      font-family: var(--font-mono);
      margin-top: 1px;
    }
    .header-badge {
      margin-left: auto;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 4px 12px;
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--text-dim);
      letter-spacing: 0.5px;
    }
    .header-badge span { color: var(--green); }

    /* â”€â”€ Main layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 24px 32px;
      gap: 20px;
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
    }

    /* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }
    .card-header {
      padding: 12px 18px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      color: var(--text-dim);
    }
    .card-header .icon { font-size: 14px; }

    /* â”€â”€ Input Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .input-panel { flex-shrink: 0; }
    .input-body { padding: 16px; display: flex; flex-direction: column; gap: 12px; }

    textarea#description {
      width: 100%;
      min-height: 110px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 13px;
      line-height: 1.7;
      padding: 12px 14px;
      resize: vertical;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    textarea#description::placeholder { color: var(--text-dim); }
    textarea#description:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-glow);
    }
    textarea#description:disabled { opacity: 0.5; cursor: not-allowed; }

    .input-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .label {
      font-size: 11px;
      color: var(--text-dim);
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    select#examples {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-family: var(--font-ui);
      font-size: 13px;
      padding: 7px 10px;
      outline: none;
      cursor: pointer;
      flex: 1;
      min-width: 200px;
      max-width: 480px;
      transition: border-color 0.2s;
    }
    select#examples:hover { border-color: var(--border2); }
    select#examples:focus { border-color: var(--accent); }
    select#examples option { background: var(--surface2); }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 8px 18px;
      border-radius: var(--radius);
      border: none;
      font-family: var(--font-ui);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      outline: none;
    }
    .btn:disabled { opacity: 0.45; cursor: not-allowed; }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: #fff;
      box-shadow: 0 2px 8px rgba(37,99,235,0.35);
    }
    .btn-primary:not(:disabled):hover {
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
      box-shadow: 0 4px 16px rgba(37,99,235,0.5);
      transform: translateY(-1px);
    }
    .btn-primary:not(:disabled):active { transform: translateY(0); }

    .btn-danger {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      color: #fff;
      box-shadow: 0 2px 8px rgba(220,38,38,0.35);
    }
    .btn-danger:not(:disabled):hover {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      box-shadow: 0 4px 16px rgba(220,38,38,0.5);
      transform: translateY(-1px);
    }

    .btn-ghost {
      background: var(--surface2);
      color: var(--text-dim);
      border: 1px solid var(--border);
    }
    .btn-ghost:not(:disabled):hover {
      background: var(--surface3);
      color: var(--text);
      border-color: var(--border2);
    }

    .btn-sm { padding: 5px 12px; font-size: 12px; }

    /* spinning icon during run */
    @keyframes spin { to { transform: rotate(360deg); } }
    .spin { display: inline-block; animation: spin 1s linear infinite; }

    /* â”€â”€ Progress Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .progress-panel { flex-shrink: 0; }
    .progress-body { padding: 14px 18px; display: flex; flex-direction: column; gap: 10px; }

    .progress-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
    }
    .progress-step {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .step-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 6px var(--accent);
    }
    .step-dot.pulsing {
      animation: pulse-dot 1.4s ease-in-out infinite;
    }
    @keyframes pulse-dot {
      0%, 100% { box-shadow: 0 0 4px var(--accent); transform: scale(1); }
      50%       { box-shadow: 0 0 12px var(--accent); transform: scale(1.3); }
    }
    .step-name { font-weight: 600; color: var(--text); font-family: var(--font-mono); font-size: 13px; }
    .progress-stats { color: var(--text-dim); font-family: var(--font-mono); }
    .progress-stats .pct { color: var(--accent); font-weight: 700; }

    .progress-track {
      height: 6px;
      background: var(--surface3);
      border-radius: 3px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      border-radius: 3px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6);
      transition: width 0.4s ease;
      position: relative;
    }
    .progress-fill.shimmer::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      animation: shimmer 1.4s ease-in-out infinite;
    }
    @keyframes shimmer {
      0%   { transform: translateX(-100%); }
      100% { transform: translateX(200%); }
    }

    .step-pills {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .step-pill {
      padding: 2px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-family: var(--font-mono);
      border: 1px solid var(--border);
      color: var(--text-dim);
      background: var(--surface2);
      transition: all 0.3s;
    }
    .step-pill.active {
      background: var(--accent-glow);
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 8px var(--accent-glow);
    }
    .step-pill.done {
      background: rgba(34,197,94,0.1);
      border-color: var(--green);
      color: var(--green);
    }

    /* â”€â”€ Two-column main area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .work-area {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      min-height: 0;
    }
    @media (max-width: 900px) {
      .work-area { grid-template-columns: 1fr; }
    }

    /* â”€â”€ Logs panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .logs-panel { display: flex; flex-direction: column; min-height: 0; }
    .logs-body {
      flex: 1;
      overflow-y: auto;
      padding: 10px 14px;
      font-family: var(--font-mono);
      font-size: 12px;
      line-height: 1.8;
      min-height: 360px;
      max-height: 480px;
    }
    .log-entry {
      display: flex;
      gap: 8px;
      align-items: flex-start;
      padding: 1px 0;
      border-radius: 3px;
      transition: background 0.1s;
    }
    .log-entry:hover { background: rgba(255,255,255,0.03); }

    .log-ts {
      color: var(--text-dim);
      flex-shrink: 0;
      font-size: 11px;
      padding-top: 1px;
    }
    .log-icon { flex-shrink: 0; width: 16px; text-align: center; }
    .log-step {
      flex-shrink: 0;
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 3px;
      background: var(--surface3);
      color: var(--text-dim);
      align-self: center;
      letter-spacing: 0.3px;
    }
    .log-msg { flex: 1; word-break: break-word; }

    .log-info    .log-msg { color: #93c5fd; }
    .log-success .log-msg { color: var(--green); }
    .log-warn    .log-msg { color: var(--yellow); }
    .log-error   .log-msg { color: var(--red); }
    .log-info    .log-icon::before { content: 'â€º'; color: #93c5fd; }
    .log-success .log-icon::before { content: 'âœ“'; color: var(--green); }
    .log-warn    .log-icon::before { content: 'âš '; color: var(--yellow); }
    .log-error   .log-icon::before { content: 'âœ—'; color: var(--red); }

    .logs-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: var(--text-dim);
      gap: 8px;
    }
    .logs-empty .icon { font-size: 32px; opacity: 0.3; }
    .logs-empty p { font-size: 12px; font-family: var(--font-mono); }

    .logs-footer {
      padding: 8px 14px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .log-count { font-size: 11px; font-family: var(--font-mono); color: var(--text-dim); }
    .log-clear { font-size: 11px; cursor: pointer; color: var(--text-dim); text-decoration: none; }
    .log-clear:hover { color: var(--text); }

    /* â”€â”€ Results panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .results-panel { display: flex; flex-direction: column; min-height: 0; }
    .results-body { flex: 1; overflow-y: auto; padding: 16px; min-height: 360px; max-height: 480px; }

    .results-idle {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      min-height: 300px;
      color: var(--text-dim);
      gap: 12px;
    }
    .results-idle .icon { font-size: 40px; opacity: 0.2; }
    .results-idle p { font-size: 13px; text-align: center; }

    /* Risk badge */
    .risk-banner {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      border-radius: var(--radius);
      margin-bottom: 16px;
      border: 1px solid;
    }
    .risk-banner.RED    { background: rgba(239,68,68,0.1);  border-color: rgba(239,68,68,0.4); }
    .risk-banner.YELLOW { background: rgba(234,179,8,0.1);  border-color: rgba(234,179,8,0.4); }
    .risk-banner.GREEN  { background: rgba(34,197,94,0.1);  border-color: rgba(34,197,94,0.4); }

    .risk-badge {
      font-size: 11px;
      font-weight: 800;
      letter-spacing: 1.5px;
      padding: 4px 12px;
      border-radius: 20px;
      text-transform: uppercase;
      flex-shrink: 0;
    }
    .risk-badge.RED    { background: var(--red);    color: #fff; box-shadow: 0 2px 8px rgba(239,68,68,0.5); }
    .risk-badge.YELLOW { background: var(--yellow); color: #000; box-shadow: 0 2px 8px rgba(234,179,8,0.5); }
    .risk-badge.GREEN  { background: var(--green);  color: #000; box-shadow: 0 2px 8px rgba(34,197,94,0.5); }

    .risk-summary { font-size: 13px; color: var(--text); flex: 1; }
    .risk-summary strong { display: block; font-size: 14px; margin-bottom: 2px; }

    /* Finding counts */
    .finding-counts {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .count-chip {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid;
      font-family: var(--font-mono);
    }
    .count-chip.critical { background: rgba(239,68,68,0.12); border-color: rgba(239,68,68,0.4); color: var(--red); }
    .count-chip.high     { background: rgba(249,115,22,0.12); border-color: rgba(249,115,22,0.4); color: var(--orange); }
    .count-chip.medium   { background: rgba(234,179,8,0.12);  border-color: rgba(234,179,8,0.4);  color: var(--yellow); }
    .count-chip.low      { background: rgba(34,197,94,0.12);  border-color: rgba(34,197,94,0.4);  color: var(--green); }

    /* Findings list */
    .findings-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
    .finding-item {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-left: 3px solid;
      border-radius: 0 var(--radius) var(--radius) 0;
      padding: 10px 12px;
    }
    .finding-item.critical { border-left-color: var(--red); }
    .finding-item.high     { border-left-color: var(--orange); }
    .finding-item.medium   { border-left-color: var(--yellow); }
    .finding-item.low      { border-left-color: var(--green); }
    .finding-item.info     { border-left-color: var(--accent); }

    .finding-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .sev-tag {
      font-size: 10px; font-weight: 700; letter-spacing: 0.8px;
      padding: 1px 7px; border-radius: 3px; text-transform: uppercase;
    }
    .sev-tag.critical { background: rgba(239,68,68,0.2); color: var(--red); }
    .sev-tag.high     { background: rgba(249,115,22,0.2); color: var(--orange); }
    .sev-tag.medium   { background: rgba(234,179,8,0.2);  color: var(--yellow); }
    .sev-tag.low      { background: rgba(34,197,94,0.2);  color: var(--green); }
    .sev-tag.info     { background: rgba(79,142,247,0.2);  color: var(--accent); }

    .finding-title { font-size: 13px; font-weight: 600; }
    .finding-desc { font-size: 12px; color: var(--text-dim); margin-top: 2px; }

    /* Artifact links */
    .artifacts-section { margin-top: 12px; }
    .artifacts-section .section-label {
      font-size: 11px; letter-spacing: 0.8px; text-transform: uppercase;
      color: var(--text-dim); font-weight: 600; margin-bottom: 8px;
    }
    .artifact-list { display: flex; flex-direction: column; gap: 6px; }
    .artifact-link {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.18s;
      text-decoration: none;
    }
    .artifact-link:hover {
      background: var(--surface3);
      border-color: var(--accent);
      transform: translateX(2px);
    }
    .artifact-link .af-icon { font-size: 16px; flex-shrink: 0; }
    .artifact-link .af-name { font-size: 13px; color: var(--text); font-weight: 500; flex: 1; }
    .artifact-link .af-type { font-size: 11px; color: var(--text-dim); font-family: var(--font-mono); }
    .artifact-link .af-arrow { color: var(--text-dim); font-size: 12px; }

    /* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 1000;
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .modal-overlay.open { display: flex; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 900px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      animation: modal-in 0.2s ease;
    }
    @keyframes modal-in {
      from { opacity: 0; transform: scale(0.96) translateY(8px); }
      to   { opacity: 1; transform: scale(1) translateY(0); }
    }

    .modal-header {
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .modal-title { font-size: 14px; font-weight: 600; flex: 1; }
    .modal-close {
      width: 28px; height: 28px;
      border-radius: 6px;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text-dim);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px;
      transition: all 0.15s;
    }
    .modal-close:hover { background: var(--red); color: #fff; border-color: var(--red); }

    .modal-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      padding: 0 18px;
      gap: 0;
    }
    .modal-tab {
      padding: 9px 16px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      color: var(--text-dim);
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: all 0.15s;
      letter-spacing: 0.3px;
    }
    .modal-tab:hover { color: var(--text); }
    .modal-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

    .modal-body { flex: 1; overflow: hidden; position: relative; }

    .modal-pane {
      position: absolute; inset: 0;
      overflow: auto;
      display: none;
    }
    .modal-pane.active { display: block; }

    .modal-pane iframe {
      width: 100%; height: 100%;
      border: none;
      background: #fff;
    }

    .modal-pane .md-content {
      padding: 24px;
      font-size: 14px;
      line-height: 1.8;
      color: var(--text);
    }
    .md-content h1, .md-content h2, .md-content h3 {
      color: var(--text); margin: 1.2em 0 0.5em;
      font-weight: 700;
    }
    .md-content h1 { font-size: 20px; }
    .md-content h2 { font-size: 16px; border-bottom: 1px solid var(--border); padding-bottom: 6px; }
    .md-content h3 { font-size: 14px; }
    .md-content p  { margin-bottom: 1em; color: var(--text-dim); }
    .md-content code {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 4px; padding: 1px 5px;
      font-family: var(--font-mono); font-size: 12px; color: var(--cyan);
    }
    .md-content pre {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 14px 16px; overflow-x: auto;
      margin: 1em 0;
    }
    .md-content pre code { background: none; border: none; padding: 0; font-size: 12px; color: var(--text); }
    .md-content ul, .md-content ol { padding-left: 1.5em; margin-bottom: 1em; color: var(--text-dim); }
    .md-content li { margin-bottom: 4px; }
    .md-content strong { color: var(--text); }
    .md-content blockquote {
      border-left: 3px solid var(--accent); margin: 1em 0;
      padding: 8px 16px; background: var(--accent-glow); border-radius: 0 4px 4px 0;
    }
    .md-content table { border-collapse: collapse; width: 100%; margin: 1em 0; }
    .md-content th, .md-content td { border: 1px solid var(--border); padding: 8px 12px; text-align: left; }
    .md-content th { background: var(--surface2); font-weight: 600; }

    .modal-pane .json-content {
      padding: 16px;
      font-family: var(--font-mono);
      font-size: 12px;
      line-height: 1.7;
      color: #a8d5f7;
      white-space: pre;
    }

    /* JSON syntax coloring */
    .json-key    { color: #93c5fd; }
    .json-string { color: #86efac; }
    .json-number { color: #fcd34d; }
    .json-bool   { color: #f472b6; }
    .json-null   { color: #fb923c; }

    /* â”€â”€ Status bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .status-bar {
      flex-shrink: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 6px 32px;
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--text-dim);
    }
    .status-dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--text-dim);
      flex-shrink: 0;
    }
    .status-dot.idle    { background: var(--text-dim); }
    .status-dot.running { background: var(--accent); animation: pulse-dot 1s ease-in-out infinite; }
    .status-dot.done    { background: var(--green); }
    .status-dot.failed  { background: var(--red); }

    #status-text { flex: 1; }
    .status-right { margin-left: auto; display: flex; gap: 16px; color: var(--text-dim); }

    /* â”€â”€ Transitions / utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hidden { display: none !important; }
    .fade-in { animation: fade-in 0.3s ease; }
    @keyframes fade-in { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="header">
  <div class="header-logo">ğŸ”´</div>
  <div>
    <div class="header-title">Red Team Your Bridge</div>
    <div class="header-sub">Natural Language Bridge Analyzer â€” NLB v1.0</div>
  </div>
  <div class="header-badge">NLB <span>â— ONLINE</span></div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<main class="main">

  <!-- Input panel -->
  <section class="card input-panel">
    <div class="card-header">
      <span class="icon">ğŸ“</span> Bridge Description
    </div>
    <div class="input-body">
      <textarea
        id="description"
        placeholder="Describe your bridge in plain languageâ€¦&#10;e.g. 3-span continuous steel plate girder over the Kishwaukee River, 315-420-315 ft spans, 7 girders at 9.5 ft spacing, ILM erection."
      ></textarea>
      <div class="input-controls">
        <span class="label">Examples:</span>
        <select id="examples">
          <option value="">â€” pick a preset â€”</option>
          <option value="preset-1">3-span steel plate girder (I-39 / Kishwaukee River)</option>
          <option value="preset-2">Single-span prestressed I-girder (rural Tennessee)</option>
          <option value="preset-3">2-span concrete box girder (Southern California)</option>
        </select>
        <button id="btn-run" class="btn btn-primary">
          <span id="run-icon">â–¶</span>
          <span id="run-label">Run Analysis</span>
        </button>
        <button id="btn-cancel" class="btn btn-danger hidden">
          <span>â– </span>
          <span>Stop</span>
        </button>
      </div>
    </div>
  </section>

  <!-- Progress panel (hidden until run starts) -->
  <section class="card progress-panel hidden" id="progress-panel">
    <div class="card-header">
      <span class="icon">âš¡</span> Pipeline Progress
    </div>
    <div class="progress-body">
      <div class="progress-meta">
        <div class="progress-step">
          <div class="step-dot" id="step-dot"></div>
          <span class="step-name" id="step-name">Initializingâ€¦</span>
        </div>
        <div class="progress-stats">
          <span class="pct" id="pct-label">0%</span>
          <span>&nbsp;Â·&nbsp;</span>
          <span id="elapsed-label">0s</span>
        </div>
      </div>
      <div class="progress-track">
        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
      </div>
      <div class="step-pills" id="step-pills">
        <div class="step-pill" data-step="site_recon">site_recon</div>
        <div class="step-pill" data-step="building">building</div>
        <div class="step-pill" data-step="assembling">assembling</div>
        <div class="step-pill" data-step="analyzing">analyzing</div>
        <div class="step-pill" data-step="red_team">red_team</div>
        <div class="step-pill" data-step="report">report</div>
      </div>
    </div>
  </section>

  <!-- Two-column work area -->
  <div class="work-area">

    <!-- Live logs -->
    <div class="card logs-panel">
      <div class="card-header">
        <span class="icon">ğŸ“‹</span> Live Logs
        <span id="stream-badge" class="hidden" style="
          margin-left: auto; font-size: 10px; padding: 1px 7px;
          border-radius: 20px; background: rgba(79,142,247,0.15);
          border: 1px solid rgba(79,142,247,0.4); color: var(--accent);
          font-family: var(--font-mono); letter-spacing: 0.5px; animation: pulse-dot 1.2s infinite;
        ">â— LIVE</span>
      </div>
      <div class="logs-body" id="logs-body">
        <div class="logs-empty" id="logs-empty">
          <div class="icon">ğŸ–¥</div>
          <p>Logs will stream here when you run an analysis.</p>
        </div>
      </div>
      <div class="logs-footer">
        <span class="log-count" id="log-count">0 lines</span>
        <a class="log-clear" id="log-clear" href="#">Clear</a>
      </div>
    </div>

    <!-- Results -->
    <div class="card results-panel">
      <div class="card-header">
        <span class="icon">ğŸ“Š</span> Results
      </div>
      <div class="results-body" id="results-body">
        <div class="results-idle" id="results-idle">
          <div class="icon">ğŸ”</div>
          <p>Results will appear here after the pipeline completes.</p>
        </div>
        <div class="results-content hidden fade-in" id="results-content">
          <!-- filled by JS -->
        </div>
      </div>
    </div>

  </div>
</main>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATUS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="status-bar">
  <div class="status-dot idle" id="status-dot"></div>
  <span id="status-text">Ready</span>
  <div class="status-right">
    <span id="run-id-display">no active run</span>
    <span>NLB v1.0 Â· FastAPI</span>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <span class="icon" id="modal-icon">ğŸ“„</span>
      <span class="modal-title" id="modal-title">Artifact Viewer</span>
      <button class="modal-close" id="modal-close" title="Close">âœ•</button>
    </div>
    <div class="modal-tabs" id="modal-tabs">
      <!-- tabs injected per artifact type -->
    </div>
    <div class="modal-body" id="modal-body">
      <!-- panes injected per artifact type -->
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
(function () {
  'use strict';

  /* â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const state = {
    runId:      null,
    running:    false,
    logCount:   0,
    sseSource:  null,
    pollTimer:  null,
    startTs:    null,
    elapsedInt: null,
    stepHistory: new Set(),
    examples: [
      null,
      "3-span continuous steel plate girder over the Kishwaukee River on I-39 in northern Illinois. 315-420-315 ft spans, 7 girders at 9.5 ft spacing. ILM erection.",
      "Single-span prestressed I-girder bridge, 80 ft span, 5 girders at 8 ft spacing, rural Tennessee.",
      "2-span concrete box girder over a creek in southern California, 120-120 ft spans."
    ]
  };

  /* â”€â”€ Elements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const $ = id => document.getElementById(id);
  const el = {
    description:  $('description'),
    examples:     $('examples'),
    btnRun:       $('btn-run'),
    btnCancel:    $('btn-cancel'),
    runIcon:      $('run-icon'),
    runLabel:     $('run-label'),
    progressPanel:$('progress-panel'),
    stepDot:      $('step-dot'),
    stepName:     $('step-name'),
    pctLabel:     $('pct-label'),
    elapsedLabel: $('elapsed-label'),
    progressFill: $('progress-fill'),
    stepPills:    $('step-pills'),
    logsBody:     $('logs-body'),
    logsEmpty:    $('logs-empty'),
    logCount:     $('log-count'),
    logClear:     $('log-clear'),
    streamBadge:  $('stream-badge'),
    resultsIdle:  $('results-idle'),
    resultsContent:$('results-content'),
    statusDot:    $('status-dot'),
    statusText:   $('status-text'),
    runIdDisplay: $('run-id-display'),
    modalOverlay: $('modal-overlay'),
    modalIcon:    $('modal-icon'),
    modalTitle:   $('modal-title'),
    modalClose:   $('modal-close'),
    modalTabs:    $('modal-tabs'),
    modalBody:    $('modal-body'),
  };

  /* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function fmtTime(sec) {
    if (sec < 60) return sec.toFixed(0) + 's';
    const m = Math.floor(sec / 60);
    const s = (sec % 60).toFixed(0).padStart(2, '0');
    return `${m}m ${s}s`;
  }

  function fmtTs(iso) {
    try {
      const d = new Date(iso);
      return d.toTimeString().slice(0, 8);
    } catch { return ''; }
  }

  function setStatus(state, text) {
    el.statusDot.className = `status-dot ${state}`;
    el.statusText.textContent = text;
  }

  function addClass(el, cls) { el.classList.add(cls); }
  function removeClass(el, cls) { el.classList.remove(cls); }

  /* â”€â”€ Example presets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function loadExamples() {
    try {
      const r = await fetch('/api/examples');
      if (!r.ok) return;
      const data = await r.json();
      if (Array.isArray(data.examples) && data.examples.length) {
        state.examples = [null, ...data.examples];
        Array.from(el.examples.options).forEach((opt, i) => {
          if (i > 0 && state.examples[i]) {
            opt.text = state.examples[i].slice(0, 80) + 'â€¦';
          }
        });
      }
    } catch { /* use built-ins */ }
  }

  el.examples.addEventListener('change', () => {
    const idx = parseInt(el.examples.value.replace('preset-', ''), 10);
    if (idx && state.examples[idx]) {
      el.description.value = state.examples[idx];
      el.description.focus();
      el.examples.value = '';
    }
  });

  /* â”€â”€ Log rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function appendLog(entry) {
    if (el.logsEmpty.style.display !== 'none') {
      el.logsEmpty.style.display = 'none';
    }

    const { ts, level = 'info', message = '', step = '' } = entry;
    state.logCount++;
    el.logCount.textContent = state.logCount + (state.logCount === 1 ? ' line' : ' lines');

    const row = document.createElement('div');
    row.className = `log-entry log-${level}`;
    row.innerHTML = `
      <span class="log-ts">${fmtTs(ts) || '--:--:--'}</span>
      <span class="log-icon"></span>
      ${step ? `<span class="log-step">${escHtml(step)}</span>` : ''}
      <span class="log-msg">${escHtml(message)}</span>
    `;

    el.logsBody.appendChild(row);
    el.logsBody.scrollTop = el.logsBody.scrollHeight;
  }

  function escHtml(s) {
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  el.logClear.addEventListener('click', e => {
    e.preventDefault();
    el.logsBody.innerHTML = '';
    el.logsBody.appendChild(el.logsEmpty);
    el.logsEmpty.style.display = '';
    state.logCount = 0;
    el.logCount.textContent = '0 lines';
  });

  /* â”€â”€ Progress updates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function updateProgress(step, progress, elapsed) {
    el.stepName.textContent = step ? step.replace(/_/g, ' ') : 'Runningâ€¦';
    el.pctLabel.textContent = (progress || 0) + '%';
    el.elapsedLabel.textContent = fmtTime(elapsed || 0);

    const fill = el.progressFill;
    fill.style.width = (progress || 0) + '%';
    addClass(fill, 'shimmer');

    // Step pills
    const pills = el.stepPills.querySelectorAll('.step-pill');
    pills.forEach(p => {
      const s = p.dataset.step;
      if (s === step) {
        p.className = 'step-pill active';
        state.stepHistory.add(s);
      } else if (state.stepHistory.has(s) && s !== step) {
        p.className = 'step-pill done';
      }
    });
  }

  /* â”€â”€ Run button UI state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function setRunning(yes) {
    state.running = yes;
    el.btnRun.disabled = yes;
    el.description.disabled = yes;

    if (yes) {
      el.runIcon.textContent = '';
      el.runIcon.innerHTML = '<span class="spin">âŸ³</span>';
      el.runLabel.textContent = 'Runningâ€¦';
      addClass(el.btnCancel, 'hidden');
      removeClass(el.btnCancel, 'hidden');
      addClass(el.stepDot, 'pulsing');
      removeClass(el.progressPanel, 'hidden');
      addClass(el.streamBadge, 'hidden');
      removeClass(el.streamBadge, 'hidden');
    } else {
      el.runIcon.textContent = 'â–¶';
      el.runLabel.textContent = 'Run Analysis';
      addClass(el.btnCancel, 'hidden');
      removeClass(el.stepDot, 'pulsing');
      addClass(el.streamBadge, 'hidden');
    }
  }

  /* â”€â”€ SSE Streaming â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function startSSE(runId) {
    if (state.sseSource) { state.sseSource.close(); state.sseSource = null; }

    const src = new EventSource(`/api/run/${runId}/logs`);
    state.sseSource = src;

    src.onmessage = evt => {
      try {
        const data = JSON.parse(evt.data);
        appendLog(data);
        if (data.step) updateProgress(data.step, data.progress, data.elapsed);
      } catch (e) {
        appendLog({ ts: new Date().toISOString(), level: 'info', message: evt.data });
      }
    };

    src.onerror = () => {
      // SSE closed â€” either done or network error, fall back to polling
      src.close();
      state.sseSource = null;
    };
  }

  /* â”€â”€ Status polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function startPolling(runId) {
    if (state.pollTimer) clearInterval(state.pollTimer);
    state.pollTimer = setInterval(() => pollStatus(runId), 1200);
  }

  async function pollStatus(runId) {
    try {
      const r = await fetch(`/api/run/${runId}/status`);
      if (!r.ok) return;
      const d = await r.json();

      updateProgress(d.step, d.progress, d.elapsed);

      if (d.status === 'completed') {
        finishRun(runId, true);
      } else if (d.status === 'failed') {
        finishRun(runId, false);
      }
    } catch { /* network hiccup, retry */ }
  }

  /* â”€â”€ Finish run â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function finishRun(runId, success) {
    clearInterval(state.pollTimer);
    clearInterval(state.elapsedInt);
    if (state.sseSource) { state.sseSource.close(); state.sseSource = null; }

    el.progressFill.style.width = success ? '100%' : el.progressFill.style.width;
    removeClass(el.progressFill, 'shimmer');
    el.pctLabel.textContent = success ? '100%' : 'FAILED';
    removeClass(el.stepDot, 'pulsing');
    el.stepDot.style.background = success ? 'var(--green)' : 'var(--red)';
    el.stepName.textContent = success ? 'Complete âœ“' : 'Failed âœ—';

    setRunning(false);
    setStatus(success ? 'done' : 'failed', success ? 'Analysis complete' : 'Pipeline failed');

    if (success) {
      await loadResults(runId);
    } else {
      appendLog({
        ts: new Date().toISOString(),
        level: 'error',
        message: 'Pipeline encountered an error. Check logs for details.'
      });
    }

    // mark all done pills
    if (success) {
      el.stepPills.querySelectorAll('.step-pill').forEach(p => {
        p.className = 'step-pill done';
      });
    }
  }

  /* â”€â”€ Load results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function loadResults(runId) {
    try {
      const [resResp, artResp] = await Promise.all([
        fetch(`/api/run/${runId}/results`),
        fetch(`/api/run/${runId}/artifacts`)
      ]);

      const results   = resResp.ok  ? await resResp.json()  : null;
      const artData   = artResp.ok  ? await artResp.json()  : null;
      const artifacts = artData?.artifacts || [];

      renderResults(results, artifacts, runId);
    } catch (e) {
      appendLog({ ts: new Date().toISOString(), level: 'error', message: 'Failed to load results: ' + e.message });
    }
  }

  /* â”€â”€ Render results panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function renderResults(results, artifacts, runId) {
    addClass(el.resultsIdle, 'hidden');
    removeClass(el.resultsContent, 'hidden');
    el.resultsContent.innerHTML = '';

    // Risk banner
    const risk = results?.risk_rating || results?.risk || 'UNKNOWN';
    const riskColor = { RED: 'var(--red)', YELLOW: 'var(--yellow)', GREEN: 'var(--green)' }[risk] || 'var(--text-dim)';
    const riskEmoji = { RED: 'ğŸ”´', YELLOW: 'ğŸŸ¡', GREEN: 'ğŸŸ¢' }[risk] || 'âšª';

    const banner = document.createElement('div');
    banner.className = `risk-banner ${risk}`;
    banner.innerHTML = `
      <span class="risk-badge ${risk}">${riskEmoji} ${risk}</span>
      <div class="risk-summary">
        <strong>${results?.summary || 'Analysis complete'}</strong>
        ${results?.description || ''}
      </div>
    `;
    el.resultsContent.appendChild(banner);

    // Finding counts
    const findings = results?.findings || [];
    if (findings.length) {
      const counts = {};
      findings.forEach(f => { counts[f.severity || f.level || 'info'] = (counts[f.severity || f.level || 'info'] || 0) + 1; });
      const countRow = document.createElement('div');
      countRow.className = 'finding-counts';
      ['critical','high','medium','low','info'].forEach(sev => {
        if (counts[sev]) {
          const chip = document.createElement('span');
          chip.className = `count-chip ${sev}`;
          chip.textContent = `${counts[sev]} ${sev.toUpperCase()}`;
          countRow.appendChild(chip);
        }
      });
      el.resultsContent.appendChild(countRow);

      // Findings list
      const list = document.createElement('div');
      list.className = 'findings-list';
      findings.slice(0, 12).forEach(f => {
        const sev = f.severity || f.level || 'info';
        const item = document.createElement('div');
        item.className = `finding-item ${sev} fade-in`;
        item.innerHTML = `
          <div class="finding-header">
            <span class="sev-tag ${sev}">${sev}</span>
            <span class="finding-title">${escHtml(f.title || f.name || f.message || 'Finding')}</span>
          </div>
          ${f.description || f.detail || f.body
            ? `<div class="finding-desc">${escHtml(f.description || f.detail || f.body)}</div>`
            : ''}
        `;
        list.appendChild(item);
      });
      if (findings.length > 12) {
        const more = document.createElement('div');
        more.style.cssText = 'color:var(--text-dim);font-size:12px;text-align:center;padding:4px 0;';
        more.textContent = `â€¦and ${findings.length - 12} more (see full report)`;
        list.appendChild(more);
      }
      el.resultsContent.appendChild(list);
    }

    // Artifacts
    if (artifacts.length) {
      const section = document.createElement('div');
      section.className = 'artifacts-section';
      section.innerHTML = '<div class="section-label">Artifacts</div>';
      const artList = document.createElement('div');
      artList.className = 'artifact-list';

      artifacts.forEach(art => {
        const icon = artIcon(art.type, art.name);
        const link = document.createElement('div');
        link.className = 'artifact-link';
        link.innerHTML = `
          <span class="af-icon">${icon}</span>
          <span class="af-name">${escHtml(art.name)}</span>
          <span class="af-type">${(art.type || '').toUpperCase()}</span>
          <span class="af-arrow">â€º</span>
        `;
        link.addEventListener('click', () => openArtifact(art, runId, results));
        artList.appendChild(link);
      });

      // Also offer raw JSON
      if (results) {
        const jsonLink = document.createElement('div');
        jsonLink.className = 'artifact-link';
        jsonLink.innerHTML = `
          <span class="af-icon">{ }</span>
          <span class="af-name">results.json</span>
          <span class="af-type">JSON</span>
          <span class="af-arrow">â€º</span>
        `;
        jsonLink.addEventListener('click', () => openJsonModal('Results JSON', results));
        artList.appendChild(jsonLink);
      }

      section.appendChild(artList);
      el.resultsContent.appendChild(section);
    } else if (results) {
      // no artifacts list but we have results json
      const section = document.createElement('div');
      section.className = 'artifacts-section';
      section.innerHTML = '<div class="section-label">Raw Output</div>';
      const artList = document.createElement('div');
      artList.className = 'artifact-list';
      const jsonLink = document.createElement('div');
      jsonLink.className = 'artifact-link';
      jsonLink.innerHTML = `
        <span class="af-icon">{ }</span>
        <span class="af-name">results.json</span>
        <span class="af-type">JSON</span>
        <span class="af-arrow">â€º</span>
      `;
      jsonLink.addEventListener('click', () => openJsonModal('Results JSON', results));
      artList.appendChild(jsonLink);
      section.appendChild(artList);
      el.resultsContent.appendChild(section);
    }
  }

  function artIcon(type, name) {
    if (type === 'html' || (name && name.endsWith('.html'))) return 'ğŸ“ˆ';
    if (type === 'md'   || (name && name.endsWith('.md')))   return 'ğŸ“„';
    if (type === 'json' || (name && name.endsWith('.json'))) return '{ }';
    if (type === 'pdf'  || (name && name.endsWith('.pdf')))  return 'ğŸ“‘';
    return 'ğŸ“';
  }

  /* â”€â”€ Artifact modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function openArtifact(art, runId, results) {
    const url = art.url || `/api/run/${runId}/artifact/${encodeURIComponent(art.name)}`;
    const type = art.type || (art.name.endsWith('.html') ? 'html' : art.name.endsWith('.md') ? 'md' : 'json');

    el.modalIcon.textContent = artIcon(type, art.name);
    el.modalTitle.textContent = art.name;

    el.modalTabs.innerHTML = '';
    el.modalBody.innerHTML = '';

    if (type === 'html') {
      showIframeModal(url);
    } else if (type === 'md') {
      try {
        const r = await fetch(url);
        const text = r.ok ? await r.text() : '# Error\nCould not load artifact.';
        showMdModal(text);
      } catch {
        showMdModal('# Error\nFailed to fetch artifact.');
      }
    } else if (type === 'json') {
      try {
        const r = await fetch(url);
        const json = r.ok ? await r.json() : { error: 'fetch failed' };
        openJsonModal(art.name, json);
        return; // openJsonModal handles the modal open
      } catch {
        openJsonModal(art.name, { error: 'failed to load' });
        return;
      }
    } else {
      // Generic â€” try iframe first
      showIframeModal(url);
    }

    el.modalOverlay.classList.add('open');
  }

  function showIframeModal(url) {
    addTab('Preview', true);
    const pane = makePaneActive();
    const iframe = document.createElement('iframe');
    iframe.src = url;
    iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin');
    pane.appendChild(iframe);

    addTab('Open â†’', false);
    const pane2 = makePaneInactive();
    pane2.innerHTML = `<div style="padding:24px;font-size:13px;color:var(--text-dim);">
      <a href="${escHtml(url)}" target="_blank" style="color:var(--accent);">Open in new tab â†—</a>
    </div>`;
  }

  function showMdModal(md) {
    addTab('Rendered', true);
    const pane = makePaneActive();
    const div = document.createElement('div');
    div.className = 'md-content';
    div.innerHTML = typeof marked !== 'undefined' ? marked.parse(md) : `<pre>${escHtml(md)}</pre>`;
    pane.appendChild(div);

    addTab('Source', false);
    const pane2 = makePaneInactive();
    pane2.innerHTML = `<pre style="padding:16px;font-family:var(--font-mono);font-size:12px;color:var(--text-dim);white-space:pre-wrap;">${escHtml(md)}</pre>`;
  }

  function openJsonModal(title, json) {
    el.modalIcon.textContent = '{ }';
    el.modalTitle.textContent = title;
    el.modalTabs.innerHTML = '';
    el.modalBody.innerHTML = '';

    addTab('Pretty', true);
    const pane = makePaneActive();
    const pre = document.createElement('div');
    pre.className = 'json-content';
    pre.innerHTML = syntaxHighlightJson(JSON.stringify(json, null, 2));
    pane.appendChild(pre);

    el.modalOverlay.classList.add('open');
  }

  function addTab(label, active) {
    const tab = document.createElement('div');
    tab.className = 'modal-tab' + (active ? ' active' : '');
    tab.textContent = label;
    const idx = el.modalTabs.children.length;
    tab.dataset.idx = idx;
    tab.addEventListener('click', () => switchTab(idx));
    el.modalTabs.appendChild(tab);
  }

  function makePaneActive() {
    const pane = document.createElement('div');
    pane.className = 'modal-pane active';
    el.modalBody.appendChild(pane);
    return pane;
  }

  function makePaneInactive() {
    const pane = document.createElement('div');
    pane.className = 'modal-pane';
    el.modalBody.appendChild(pane);
    return pane;
  }

  function switchTab(idx) {
    el.modalTabs.querySelectorAll('.modal-tab').forEach((t, i) => {
      t.classList.toggle('active', i === idx);
    });
    el.modalBody.querySelectorAll('.modal-pane').forEach((p, i) => {
      p.classList.toggle('active', i === idx);
    });
  }

  el.modalClose.addEventListener('click', () => el.modalOverlay.classList.remove('open'));
  el.modalOverlay.addEventListener('click', e => {
    if (e.target === el.modalOverlay) el.modalOverlay.classList.remove('open');
  });
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') el.modalOverlay.classList.remove('open');
  });

  /* â”€â”€ JSON syntax highlighting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function syntaxHighlightJson(str) {
    return str
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(
        /("(\\u[a-fA-F0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
        match => {
          if (/^"/.test(match)) {
            if (/:$/.test(match)) return `<span class="json-key">${match}</span>`;
            return `<span class="json-string">${match}</span>`;
          }
          if (/true|false/.test(match)) return `<span class="json-bool">${match}</span>`;
          if (/null/.test(match)) return `<span class="json-null">${match}</span>`;
          return `<span class="json-number">${match}</span>`;
        }
      );
  }

  /* â”€â”€ Run pipeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function startRun() {
    const desc = el.description.value.trim();
    if (!desc) {
      el.description.focus();
      el.description.style.borderColor = 'var(--red)';
      setTimeout(() => el.description.style.borderColor = '', 1200);
      return;
    }

    // Reset state
    state.stepHistory.clear();
    el.stepPills.querySelectorAll('.step-pill').forEach(p => p.className = 'step-pill');
    el.stepDot.style.background = '';
    el.progressFill.style.width = '0%';
    el.pctLabel.textContent = '0%';
    el.elapsedLabel.textContent = '0s';
    el.stepName.textContent = 'Initializingâ€¦';
    addClass(el.progressFill, 'shimmer');

    // Hide results
    addClass(el.resultsContent, 'hidden');
    removeClass(el.resultsIdle, 'hidden');
    el.resultsContent.innerHTML = '';

    setRunning(true);
    setStatus('running', 'Starting pipelineâ€¦');

    try {
      const r = await fetch('/api/run', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ description: desc })
      });

      if (!r.ok) {
        const err = await r.text();
        throw new Error(`HTTP ${r.status}: ${err}`);
      }

      const { run_id } = await r.json();
      state.runId = run_id;
      el.runIdDisplay.textContent = `run: ${run_id.slice(0, 8)}â€¦`;
      setStatus('running', `Pipeline running â€” ${run_id.slice(0, 8)}`);

      appendLog({
        ts: new Date().toISOString(),
        level: 'info',
        step: 'init',
        message: `Started run ${run_id}`
      });

      // Start elapsed timer
      state.startTs = Date.now();
      state.elapsedInt = setInterval(() => {
        const sec = (Date.now() - state.startTs) / 1000;
        el.elapsedLabel.textContent = fmtTime(sec);
      }, 500);

      // Connect SSE
      startSSE(run_id);
      // Also poll status
      startPolling(run_id);

    } catch (e) {
      setRunning(false);
      setStatus('failed', 'Failed to start: ' + e.message);
      appendLog({ ts: new Date().toISOString(), level: 'error', message: 'Run failed: ' + e.message });
    }
  }

  async function cancelRun() {
    if (!state.runId) return;
    try {
      await fetch(`/api/run/${state.runId}/cancel`, { method: 'POST' });
    } catch { /* best-effort */ }
    appendLog({ ts: new Date().toISOString(), level: 'warn', message: 'Run cancelled by user.' });
    finishRun(state.runId, false);
    setStatus('idle', 'Cancelled');
  }

  el.btnRun.addEventListener('click', startRun);
  el.btnCancel.addEventListener('click', cancelRun);

  // Ctrl+Enter to run
  el.description.addEventListener('keydown', e => {
    if (e.ctrlKey && e.key === 'Enter') startRun();
  });

  /* â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  loadExamples();
  setStatus('idle', 'Ready â€” describe your bridge and click Run Analysis');

})();
</script>
</body>
</html>
